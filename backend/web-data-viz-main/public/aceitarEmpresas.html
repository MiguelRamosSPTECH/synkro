<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="css/aceitar.css">
</head>
<body>

    <div class="container">
        <div class="sideBar">
            <img src="./assets/imgs/SYNKRO (3).png" alt="" height="150px">
                <a href="" class="link-sidebar">
                    <img src="./assets/imgs/aprovacoes_icon.png" alt="">
                </a>
                <div class="logout-area" onclick="sair()">
                    <img src="./assets/imgs/logoff_icon.png" alt="">
                </div>
         
        
        </div>
        <div class="header" >
            <div id="dados_data">
                <span id="dataHeader"></span>
                <img id="agenda_icon" src="./assets/imgs/icon_agenda.jpg" alt="">
            </div>
            <div id="info_login">
                <div id="foto_padrao_login"></div>
                <div id="dados_login">
                    <span id="nome_login">Luciano Macedo</span>
                    <span id="email_login">luci@gmail.com</span>
                </div>
            </div>
        </div>


        <div class="filtros">          
            <h2 id="title-filtros">Aprovações</h2>
            <select onchange="criarCards()" id="filtro">
                <option value="1,2,3">Todas as empresas</option> 
                <option value="1">Pendentes</option>
                <option value="2">Reprovadas</option>
                <option value="3">Aprovadas</option> 
            </select>
        </div>
        <div class="conteudo" id="div_conteudo">conteudo</div>
    </div>

</body>
    <script>

        function sair() {
            window.location = "login.html"
        }
        document.getElementById('dataHeader').textContent = new Date().toLocaleDateString();

        var id = []
        var nomeEmpresarial =  []
        var nomeRepresentante = []
        var statusOperacao = []
        var statusAcesso = []


        function criarCards() {
        
        div_conteudo.innerHTML = ''

        var filtroVar = filtro.value;

        fetch("/aceitarEmpresas/buscar_cards", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                filtroServer: filtroVar,
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO entrar()!")

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    console.log("Esse é o json.stringify" +JSON.stringify(json));
                    console.log("Tamanho volta" + json.length);
            
                    // Zerando os vetores das varievais, para poder repor os valores:
                            id = []
                            nomeEmpresarial =  []
                            nomeRepresentante = []
                            statusOperacao = []
                            statusAcesso = []

                    // Salvando em variaveis os valores retornados
                    for(i = 0; i < json.length; i++){
                        id.push(json[i].id);
                        nomeEmpresarial.push(json[i].nomeEmpresarial);
                        nomeRepresentante.push(json[i].nomeRepresentante);
                        statusOperacao.push(json[i].statusOperacao);
                        statusAcesso.push(json[i].statusAcesso);
                    }
                    
                    console.log(id);
                    console.log(nomeEmpresarial);
                    console.log(nomeRepresentante);
                    console.log(statusOperacao);
                    console.log(statusAcesso);
                    
                    // montando os cards
                    console.log("Tamanho do vetor de id:" + id.length);
                    var status = ''
                    for(i = 0; i < id.length; i++){
                        if(statusAcesso[i] == 1){
                            status = 'Pendente'
                        }
                        if(statusAcesso[i] == 2){
                            status = 'Reprovada'
                        }

                        if(statusAcesso[i] == 3){
                            status = 'Aprovada'
                        }
                        

                        div_conteudo.innerHTML += `
                    <div class="caixa">
                        <div id="div_empresa${i}"> Empresa ${i}
                        <div"> Situação ${status}
                        <button onclick="aprovar(${i})" id=aprovar${i}>Aprovar</button>
                        <button onclick="reprovar(${i})"id=reprovar${i}>Reprovar</button>
                    </div>  
                        `
                        }

                });

            } else {

                console.log("Houve um erro ao tentar buscar os cards");

            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;

    }

    criarCards()

    function aprovar(i){
       var idEmpresa1 = id[i]
       editar(idEmpresa1,3)
    }


    function reprovar(i){
       var idEmpresa2 = id[i]
       editar(idEmpresa2,2)

    }
        


    function editar(idEmpresaPassado,novoStatusPassado) {

        console.log('editar ->', { idEmpresaPassado, novoStatusPassado });
        fetch(`/aceitarEmpresas/statusEmpresa`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                novoStatus: novoStatusPassado,
                idEmpresa: idEmpresaPassado
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                window.alert("Situação de empresa atualizada com sucesso!");
                window.location = "aceitarEmpresas.html"
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }


    </script>
</html>